<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Метеокод - Обучающая система метеорологических кодов</title>
    <meta name="description" content="Программа для обучения работе с метеорологическими кодами">
    <meta name="theme-color" content="#2196F3">
    <link rel="stylesheet" href="combined.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Метеокод</h1>
            <div class="subtitle">Обучающая система для работы с метеорологическими кодами</div>
        </header>

        <div class="theme-toggle">
            <button class="btn btn-secondary" onclick="toggleTheme()" aria-label="Переключить тему"><i class="fas fa-moon"></i> Тёмная тема</button>
        </div>

        <nav class="top-menu" role="tablist">
            <button class="active" data-page="trainer" aria-selected="true" role="tab"><i class="fas fa-cloud"></i> МЕТЕОКОДЕР</button>
            <button data-page="minigame" aria-selected="false" role="tab"><i class="fas fa-gamepad"></i> МИНИ-ИГРЫ</button>
            <button data-page="help" aria-selected="false" role="tab"><i class="fas fa-question-circle"></i> СПРАВКА</button>
        </nav>

        <main id="page-trainer" class="page active" role="tabpanel">
            <div class="app-container">
                <section class="main-content">
                    <section class="main-content-inner">
                        <nav class="code-type-selector" role="tablist">
                            <button class="code-type-btn active" data-type="metar" aria-selected="true" role="tab"><i class="fas fa-plane"></i> METAR/SPECI</button>
                            <button class="code-type-btn" data-type="kn01" aria-selected="false" role="tab"><i class="fas fa-cloud-rain"></i> КН-01</button>
                            <button class="code-type-btn" data-type="taf" aria-selected="false" role="tab"><i class="fas fa-clock"></i> TAF</button>
                            <button class="code-type-btn" data-type="gamet" aria-selected="false" role="tab"><i class="fas fa-map-marked-alt"></i> GAMET</button>
                            <button class="code-type-btn" data-type="sigmet" aria-selected="false" role="tab"><i class="fas fa-exclamation-triangle"></i> SIGMET</button>
                            <button class="code-type-btn" data-type="warep" aria-selected="false" role="tab"><i class="fas fa-bolt"></i> WAREP</button>
                            <button class="code-type-btn" data-type="kn04" aria-selected="false" role="tab"><i class="fas fa-wind"></i> КН-04</button>
                            <button class="code-type-btn" data-type="airmet" aria-selected="false" role="tab"><i class="fas fa-cloud-meatball"></i> AIRMET</button>
                        </nav>

                        <!-- Message shown when selected code type is under development -->
                        <div id="dev-message" class="instructions" style="display: none; text-align: center; font-weight: 700;">
                            В разработке
                        </div>

                        <nav class="mode-selector" role="tablist">
                            <div class="mode-btn active" data-mode="decode" aria-selected="true" role="tab">
                                <i class="fas fa-search"></i>
                                <h3>Авторасшифровка</h3>
                                <p>Программа расшифрует код за вас</p>
                            </div>
                            <div class="mode-btn" data-mode="practice-decode" aria-selected="false" role="tab">
                                <i class="fas fa-check"></i>
                                <h3>Проверка знаний (Расшифровка)</h3>
                                <p>Проверьте свои навыки расшифровки</p>
                            </div>
                            <div class="mode-btn" data-mode="practice-encode" aria-selected="false" role="tab">
                                <i class="fas fa-pencil-alt"></i>
                                <h3>Проверка знаний (Кодирование)</h3>
                                <p>Закодируйте описание погоды</p>
                            </div>
                        </nav>

                        <div class="input-section">
                            <div class="mode-content active" id="decode-content">
                                <div class="instructions" id="decode-instructions">
                                    <strong>Режим авторасшифровки:</strong> Введите код в поле ниже и нажмите "Расшифровать".
                                    <ul>
                                        <li title="Международный код для текущей погоды на аэродроме">Поддержка METAR: Полная расшифровка групп.</li>
                                        <li title="Прогноз погоды на аэродроме">TAF: Включая изменения FM/TEMPO.</li>
                                        <li title="Синоптический код для наземных наблюдений">KN-01: Базовая расшифровка.</li>
                                        <li>И другие коды с подсказками.</li>
                                    </ul>
                                </div>
                                <div class="input-group">
                                    <label for="metar-input">Код:</label>
                                    <textarea id="metar-input" placeholder="Введите код..." list="code-examples"></textarea>
                                    <datalist id="code-examples">
                                        <option value="UUWW 141630Z 05007MPS 9999 SCT020 17/12 Q1011 R32/290050 NOSIG">
                                        <option value="TAF UUWW 141600Z 1418/1524 03005MPS 9999 BKN015 TX15/1412Z TN10/1503Z">
                                    </datalist>
                                </div>
                                <button class="btn" onclick="decodeCode()" aria-label="Расшифровать код"><i class="fas fa-decode"></i> Расшифровать</button>
                                <button class="btn btn-secondary" onclick="clearFields()" aria-label="Очистить поля"><i class="fas fa-trash"></i> Очистить</button>
                                <button class="btn btn-copy" onclick="copyCode('metar-input')" aria-label="Скопировать код"><i class="fas fa-copy"></i> Скопировать код</button>
                                <div id="loading-decode" class="loading" aria-live="polite" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Обработка...</div>
                                <div class="input-group">
                                    <label>Результат расшифровки:</label>
                                    <div class="result" id="decode-result">Здесь появится расшифровка кода...</div>
                                </div>
                            </div>

                            <div class="mode-content" id="practice-decode-content">
                                <div class="instructions">
                                    <strong>Режим проверки расшифровки:</strong> Расшифруйте предложенный код и проверьте свои знания.
                                    <ul>
                                        <li>Используйте подсказки в боковой панели для помощи.</li>
                                        <li>Проверьте точность температуры, ветра и видимости.</li>
                                    </ul>
                                </div>
                                <div class="input-group">
                                    <label>Код для расшифровки:</label>
                                    <div class="result" id="practice-code">UUWW 141630Z 05007MPS 9999 SCT020 17/12 Q1011 NOSIG</div>
                                    <button class="btn btn-copy" onclick="copyCode('practice-code')" aria-label="Скопировать код"><i class="fas fa-copy"></i> Скопировать код</button>
                                </div>
                                <div class="input-group">
                                    <label for="user-decode">Ваша расшифровка:</label>
                                    <textarea id="user-decode" placeholder="Введите вашу расшифровку здесь..."></textarea>
                                </div>
                                <button class="btn" onclick="checkDecode()" aria-label="Проверить расшифровку"><i class="fas fa-check"></i> Проверить</button>
                                <button class="btn btn-secondary" onclick="newPracticeCode()" aria-label="Новый код"><i class="fas fa-refresh"></i> Новый код</button>
                                <div id="loading-practice-decode" class="loading" aria-live="polite" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Проверка...</div>
                                <div class="result" id="practice-decode-result">Результат проверки...</div>
                                <div class="comparison-container" id="decode-comparison" style="display: none;">
                                    <div class="comparison-box">
                                        <h4>Ваш ответ:</h4>
                                        <div id="user-decode-display"></div>
                                    </div>
                                    <div class="comparison-box">
                                        <h4>Правильный ответ:</h4>
                                        <div id="correct-decode-display"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mode-content" id="practice-encode-content">
                                <div class="instructions">
                                    <strong>Режим проверки кодирования:</strong> Прочитайте описание погоды и закодируйте его.
                                    <ul>
                                        <li>Убедитесь в правильном формате групп.</li>
                                        <li>Используйте подсказку для структуры.</li>
                                    </ul>
                                </div>
                                <div class="input-group">
                                    <label>Описание погоды для кодирования:</label>
                                    <div class="result" id="weather-description">
                                        Здесь появится описание погоды для кодирования...
                                    </div>
                                </div>
                                <div id="encode-hint" class="result" style="display: none; margin-bottom: 1rem;"></div>
                                <div class="input-group">
                                    <label for="user-encode">Ваш код:</label>
                                    <textarea id="user-encode" placeholder="Введите ваш код здесь..." list="code-examples"></textarea>
                                </div>
                                <button class="btn" onclick="checkEncode()" aria-label="Проверить кодирование"><i class="fas fa-check"></i> Проверить кодирование</button>
                                <button class="btn btn-secondary" onclick="newEncodeExercise()" aria-label="Новое задание"><i class="fas fa-refresh"></i> Новое задание</button>
                                <button class="btn btn-secondary" onclick="showEncodeHint()" aria-label="Показать подсказку"><i class="fas fa-lightbulb"></i> Подсказка</button>
                                <button class="btn btn-secondary" onclick="showNextHint()" aria-label="Следующая подсказка" style="display: none;" id="next-hint-btn"><i class="fas fa-arrow-right"></i> Следующая подсказка</button>
                                <div id="loading-practice-encode" class="loading" aria-live="polite" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Проверка...</div>
                                <div class="result" id="practice-encode-result">Результат проверки кодирования...</div>
                                <div class="comparison-container" id="encode-comparison" style="display: none;">
                                    <div class="comparison-box">
                                        <h4>Ваш ответ:</h4>
                                        <div id="user-answer-display"></div>
                                    </div>
                                    <div class="comparison-box">
                                        <h4>Правильный ответ:</h4>
                                        <div id="correct-answer-display"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <section class="stats-container" id="trainer-stats">
                            <h4>Статистика сессии:</h4>
                            <p><i class="fas fa-tasks" style="color: blue;"></i> Расшифровано кодов: <span id="decoded-count">0</span></p>
                            <p><i class="fas fa-check-circle" style="color: green;"></i> Правильных ответов: <span id="correct-percent">0%</span></p>
                            <p><i class="fas fa-times-circle" style="color: red;"></i> Ошибок по типам:</p>
                            <ul id="errors-by-type"></ul>
                            <p><i class="fas fa-level-up-alt" style="color: orange;"></i> Уровень: <span id="trainer-level">1</span></p>
                            <progress id="level-progress" value="0" max="50"></progress>
                            <p id="badge"><i class="fas fa-award" style="color: gold;"></i> Бейдж: Новичок</p>
                            <button class="btn btn-secondary" onclick="resetStats()" aria-label="Сброс статистики"><i class="fas fa-undo"></i> Сброс статистики</button>
                        </section>
                    </section>
                </section>

                <aside class="sidebar">
                    <h3>Справочная информация</h3>
                    <div class="instructions" id="sidebar-hints">
                        <strong>METAR</strong> - авиационная регулярная сводка погоды. <span title="Подсказка: CAVOK означает видимость >10км, без значительной погоды">Подсказка по CAVOK</span>.
                    </div>
                    <div class="accordion">
                        <h4 onclick="toggleAccordion(this)" aria-expanded="false" role="button"><i class="fas fa-wind"></i> Ветер</h4>
                        <div class="panel" style="display: none;">Примеры: 05007MPS - 50° 7 м/с; VRB02KT - переменный 2 узла.</div>
                        <h4 onclick="toggleAccordion(this)" aria-expanded="false" role="button"><i class="fas fa-eye"></i> Видимость</h4>
                        <div class="panel" style="display: none;">Примеры: 9999 - 10 км+; 0500 - 500 м.</div>
                        <h4 onclick="toggleAccordion(this)" aria-expanded="false" role="button"><i class="fas fa-cloud"></i> Облачность</h4>
                        <div class="panel" style="display: none;">Примеры: SCT020 - рассеянная 2000 ft; BKN005CB - значительная 500 ft кучево-дождевые.</div>
                    </div>
                    <div class="input-group">
                        <label>Подсказки по формату:</label>
                        <div class="result" id="hints">
UUWW - Аэропорт Внуково
141630Z - 14 число, 16:30 UTC
05007MPS - Ветер 050°, 7 м/с
9999 - Видимость 10+ км
SCT020 - Облачность рассеянная на 2000 футов
17/12 - Температура 17°C, точка росы 12°C
Q1011 - Давление 1011 гПа
NOSIG - Без значительных изменений
                        </div>
                    </div>
                </aside>
            </div>
        </main>
        <section id="page-minigame" class="page" role="tabpanel">
            <div class="main-content">
                <div class="game-selector">
                    <button class="btn active" data-game="find-error">Найди ошибку!</button>
                    <button class="btn" data-game="guess-code">Угадай код!</button>
                    <button class="btn" data-game="speed-decode">Скоростная расшифровка</button>
                    <button class="btn" data-game="code-builder">Собери код</button>
                    <button class="btn" data-game="quiz-bowl">Викторина</button>
                    <button class="btn" data-game="scenario-pilot">Сценарий полёта</button>
                    <button class="btn" data-game="taf-predictor">Прогнозатор</button>
                    <button class="btn" data-game="flight-planner">Flight Planner</button>
                </div>

                <div id="game-find-error" class="game-container active">
                    <h1>МетеоКодер: Найди ошибку!</h1>
                    <p>Выбери неправильные группы в метеокоде. У тебя 3 попытки!</p>
                    <div class="stats">
                        <div>Очки: <span id="score" class="score">0</span></div>
                        <div>Уровень: <span id="level" class="level">1</span></div>
                        <div>Попытки: <span id="attempts">3</span></div>
                    </div>
                <div class="mode-buttons">
                        <button class="btn active" id="btn-metar">METAR</button>
                        <button class="btn" id="btn-taf">TAF</button>
                  </div>
                    <div class="diff-buttons">
                        <button class="btn" onclick="startGame('easy')">Лёгкий</button>
                        <button class="btn" onclick="startGame('medium')">Средний</button>
                        <button class="btn" onclick="startGame('hard')">Сложный</button>
                    </div>
                    <div id="meteo-code"></div>
                    <div>
                        <button class="btn" id="check-btn" disabled>Проверить</button>
                        <button class="btn btn-secondary" onclick="showHintFindError()">Подсказка</button>
                    </div>
                    <div id="result"></div>
                </div>

                <div id="game-guess-code" class="game-container">
                    <h1>МетеоКодер: Угадай код!</h1>
                    <p>Угадайте код для погодного явления. У тебя 3 попытки!</p>
                    <div class="stats">
                        <div>Очки: <span id="guess-score" class="score">0</span></div>
                        <div>Уровень: <span id="guess-level" class="level">1</span></div>
                        <div>Попытки: <span id="attempts-guess">3</span></div>
                    </div>
                    <div class="code-type-buttons">
                        <button class="btn active" id="guess-metar">METAR</button>
                    </div>
                    <div id="phenomenon-desc"></div>
                    <input type="text" id="guess-input" placeholder="Введите код">
                    <button class="btn btn-secondary" onclick="document.getElementById('guess-input').value = '';">Очистить</button>
                    <button class="btn" id="guess-check" disabled>Проверить</button>
                    <button class="btn btn-secondary" onclick="showHintGuessCode()">Подсказка</button>
                    <button class="btn" onclick="startGuessGame()">Новое задание</button>
                    <div id="guess-result"></div>
                </div>

                <div id="game-speed-decode" class="game-container">
                    <h1>Скоростная расшифровка</h1>
                    <p>Расшифруйте METAR за 30 секунд!</p>
                    <div class="stats">
                        <div>Очки: <span id="speed-score" class="score">0</span></div>
                        <div>Уровень: <span id="speed-level" class="level">1</span></div>
                        <div>Время: <span id="speed-timer">30</span></div>
                    </div>
                    <i class="fas fa-cog settings-icon" onclick="openSettings('speed-decode')"></i>
                    <div id="speed-metar" class="result"></div>
                    <button class="btn btn-copy" onclick="copyCode('speed-metar')">Скопировать код</button>
                    <form id="speed-form" onsubmit="return false;">
                        <label>Ветер (напр/скор): <input type="text" id="speed-wind" placeholder="27005MPS"><button class="btn btn-secondary" type="button" onclick="document.getElementById('speed-wind').value = '';">Очистить</button></label>
                        <label>Видимость: <input type="text" id="speed-vis" placeholder="9999"><button class="btn btn-secondary" type="button" onclick="document.getElementById('speed-vis').value = '';">Очистить</button></label>
                        <label>Темп/Точка росы: <input type="text" id="speed-temp" placeholder="20/16"><button class="btn btn-secondary" type="button" onclick="document.getElementById('speed-temp').value = '';">Очистить</button></label>
                        <label>QNH: <input type="text" id="speed-qnh" placeholder="Q1012"><button class="btn btn-secondary" type="button" onclick="document.getElementById('speed-qnh').value = '';">Очистить</button></label>
                        <button type="button" class="btn" onclick="checkSpeedDecode()">Проверить</button>
                        <button type="button" class="btn btn-secondary" onclick="clearSpeedDecode()">Очистить</button>
                    </form>
                    <div id="speed-result"></div>
                    <button class="btn btn-secondary" onclick="showHintSpeedDecode()">Подсказка</button>
                    <button class="btn" onclick="startSpeedDecode()">Новая игра</button>
                    <button class="btn" id="new-task-speed-decode" style="display: none;" onclick="startSpeedDecode()">Новая задача</button>
                </div>

                <div id="game-code-builder" class="game-container">
                    <h1>Собери код</h1>
                    <p>Перетащите группы в поле ответа в правильном порядке.</p>
                    <div class="stats">
                        <div>Очки: <span id="builder-score" class="score">0</span></div>
                        <div>Уровень: <span id="builder-level" class="level">1</span></div>
                        <div>Время: <span id="builder-timer" class="level">30</span></div>
                    </div>
                    <i class="fas fa-cog settings-icon" onclick="openSettings('code-builder')"></i>
                    <div id="builder-description" class="instructions">Нажмите "Новая игра"</div>

                    <div style="text-align: left; font-weight: bold; margin-bottom: 5px;">Банк кодов:</div>
                    <div id="group-pool" style="display: flex; flex-wrap: wrap; justify-content: center;" ondragover="allowDrop(event)" ondrop="dropToPool(event)">
                    </div>

                    <div style="text-align: left; font-weight: bold; margin-bottom: 5px;">Поле ответа:</div>
                    <div id="builder-dropzone" class="dropzone" ondragover="allowDrop(event)" ondrop="dropToZone(event)"></div>

                    <button class="btn" onclick="checkCodeBuilder()">Проверить</button>
                    <button class="btn btn-secondary" onclick="clearBuilderZone()">Очистить</button>
                    <div id="builder-result"></div>
                    <br>
                    <button class="btn btn-secondary" onclick="showHintCodeBuilder()">Подсказка</button>
                    <button class="btn" onclick="startCodeBuilder()">Новая игра</button>
                    <button class="btn" id="new-task-code-builder" style="display: none;" onclick="startCodeBuilder()">Новая задача</button>
                </div>

                <div id="game-quiz-bowl" class="game-container">
                    <h1>Викторина</h1>
                    <p>Ответьте на вопросы по метеокодам. Серия из 10 вопросов.</p>
                    <div class="stats">
                        <div>Очки: <span id="quiz-score" class="score">0</span></div>
                        <div>Уровень: <span id="quiz-level" class="level">1</span></div>
                        <div>Прогресс: <span id="quiz-progress">0/10</span></div>
                    </div>
                    <div id="quiz-question" style="font-size: 1.2rem; margin-bottom: 1rem;"></div>
                    <div class="quiz-options" id="quiz-options"></div>
                    <button class="btn" onclick="checkQuiz()">Проверить</button>
                    <div id="quiz-result"></div>
                    <button class="btn btn-secondary" onclick="showHintQuizBowl()">Подсказка</button>
                    <button class="btn" onclick="startQuizBowl()">Новая серия</button>
                    <button class="btn" id="new-task-quiz-bowl" style="display: none;" onclick="nextQuizQuestion()">Новая задача</button>
                </div>

                <div id="game-scenario-pilot" class="game-container">
                    <h1>Сценарий полёта</h1>
                    <p>В разработке</p>
                </div>

                <div id="game-taf-predictor" class="game-container">
                    <h1>Прогнозатор</h1>
                    <p>На основе METAR и TAF предскажите изменения.</p>
                    <div class="stats">
                        <div>Очки: <span id="taf-score" class="score">0</span></div>
                        <div>Уровень: <span id="taf-level" class="level">1</span></div>
                    </div>
                    <div id="taf-metar" class="result"></div>
                    <button class="btn btn-copy" onclick="copyCode('taf-metar')">Скопировать METAR</button>
                    <div id="taf-taf" class="result"></div>
                    <button class="btn btn-copy" onclick="copyCode('taf-taf')">Скопировать TAF</button>
                    <div id="taf-question" style="margin: 10px 0; font-weight: bold;"></div>
                    <input type="text" id="taf-answer" placeholder="Ваш ответ">
                    <button class="btn btn-secondary" onclick="document.getElementById('taf-answer').value = '';">Очистить</button>
                    <button class="btn" onclick="checkTafPredictor()">Проверить</button>
                    <div id="taf-result"></div>
                    <button class="btn btn-secondary" onclick="showHintTafPredictor()">Подсказка</button>
                    <button class="btn" onclick="startTafPredictor()">Новый прогноз</button>
                    <button class="btn" id="new-task-taf-predictor" style="display: none;" onclick="startTafPredictor()">Новая задача</button>
                </div>

                <div id="game-flight-planner" class="game-container">
                    <h1>Flight Planner</h1>
                    <p>Планируйте маршрут самолета на основе погоды: Полет, Вылет запрещен, Альтернитвный аэропорт.</p>
                    <div class="stats">
                        <div>Очки: <span id="planner-score" class="score">0</span></div>
                        <div>Уровень: <span id="planner-level" class="level">1</span></div>
                    </div>
                    <div id="planner-route"></div>
                    <select id="planner-decision">
                        <option value="">Решение</option>
                        <option value="go">Полет разрешен</option>
                        <option value="no-go">Вылет запрещен</option>
                        <option value="alternate">Альтернитвный аэропорт</option>
                    </select>
                    <button class="btn" onclick="checkFlightPlanner()">Проверить</button>
                    <div id="planner-result"></div>
                    <button class="btn btn-secondary" onclick="showHintFlightPlanner()">Подсказка</button>
                    <button class="btn" onclick="startFlightPlanner()">Новый маршрут</button>
                </div>
            </div>
        </section>

        <section id="page-help" class="page" role="tabpanel">
            <div class="main-content">
                <h2>Справочные документы</h2>
                <ul class="help-list">
                    <li><a href="https://ato.soyuz.aero/ato/files/doc/meteo_code_TAF.pdf">meteo_code_TAF.pdf</a></li>
                    <li><a href="https://firstep.ru/library/technical/technical-books/metod_kn01.pdf?ysclid=mia1o55bcn565506023">metod_kn01.pdf</a></li>
                    <li><a href="https://www.atc.spb.ru/RD/MST.pdf">Инструктивного материала по кодам METAR, SPECI, TAF</a></li>
                    <li><a href="http://ra.rshu.ru/mps/dwnl/volobueva/%D0%98%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%ba%D1%82.%20%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D0%B8%D0%B0%D0%bb_GAMET.pdf">Инструкт. материал_GAMET.pdf</a></li>
                    <li><a href="http://ra.rshu.ru/mps/dwnl/volobueva/%D0%98%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82.%20%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D0%B8%D0%B0%D0%BB_SIGMET_and_AIRMET.pdf">SIGMET and AIRMET.pdf</a></li>
                    <li><a href="https://meteoinfo.ru/images/misc/kn-01-synop.pdf?ysclid=mia1zok1rq901247982">kn-01-synop.pdf</a></li>
                    <li><a href="http://elib.rshu.ru/files_books/pdf/rid_acbfa3068d234e0faeda7cd3d0510dee.pdf">ПОСОБИЕ ПО СИНОПТИЧЕСКОЙ МЕТЕОРОЛОГИИ </a></li>
                    <li><a href="https://ohranatruda.ru/upload/iblock/8ad/4293756585.pdf?ysclid=mia214te2t824132625">Инструкция по подготовке и передаче штормовых сообщений наблюдательными подразделениями</a></li>
                </ul>
            </div>
        </section>

        <footer>
            <p>МетеоКодер - Обучающая система для метеорологов | Версия 1.5 (Улучшенная с поддержкой новых кодов)</p>
            <p>Для учебных целей</p>
        </footer>
    </div>

    <!-- Audio elements for sounds (used by games) -->
    <audio id="ding-sound" src="ding.mp3"></audio>
    <audio id="buzz-sound" src="buzz.mp3"></audio>

    <!-- Settings Panel (shared) -->
    <div id="settings-panel" class="settings-panel" style="display: none;">
        <h3>Настройки таймера</h3>
        <select id="timer-speed">
            <option value="slow">Медленный (x1.5)</option>
            <option value="normal" selected>Нормальный</option>
            <option value="fast">Быстрый (x0.5)</option>
        </select>
        <button class="btn" onclick="applySettings()">Применить</button>
        <button class="btn btn-secondary" onclick="closeSettings()">Закрыть</button>
    </div>

    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1000;"></canvas>

    <!-- Combined scripts (functions from both original files).
         Modified: when certain code types are selected in "Метеокодер", show "В разработке" message.
    -->
    <script>
        /* ------------- Shared data & utilities (from Тест40 без игр.html) ------------- */
        const weatherDatabase = [
            {
                description: "Фактическая погода по аэродрому Пулково 02.10.25 за 19.30 UTC, тихо, условия хорошие, температура 2 градуса, температура точки росы 0 градусов, давление QNH (на уровне моря по СА) 1032гПа, состояние всех ВПП: чистая и сухая, степень загрязнения 51-100%, высота отложений 0мм, коэффициент сцепления 0,6. Прогноз на посадку без изменений.",
                code: "METAR ULLI 021930Z 00000MPS CAVOK 02/00 Q1032 R88/090060 NOSIG="
            },
        ];
        let currentEncodeExercise = null;
        let trainerStats = JSON.parse(localStorage.getItem('trainerStats') || '{"level":1,"totalDecoded":0,"correctDecoded":0,"sessionDecoded":0,"sessionCorrect":0,"errorsByType":{"metar":0,"kn01":0,"taf":0,"gamet":0,"sigmet":0,"warep":0,"kn04":0,"airmet":0}}');
        let currentPracticeCode = null;
        let hintStep = 0;

        const WEATHER_CODES = {
            'MI': 'мелкий', 'BC': 'пятнами', 'PR': 'частично', 'DR': 'низкий перенос', 'BL': 'высокий перенос',
            'SH': 'ливень', 'TS': 'гроза', 'FZ': 'замерзающий',
            'DZ': 'морось', 'RA': 'дождь', 'SN': 'снег', 'SG': 'снежные зерна', 'IC': 'ледяные кристаллы',
            'PL': 'ледяная крупа', 'GR': 'град', 'GS': 'мелкий град', 'UP': 'неизвестные осадки',
            'BR': 'дымка', 'FG': 'туман', 'FU': 'дым', 'VA': 'вулканический пепел', 'DU': 'пыль',
            'SA': 'песок', 'HZ': 'мгла', 'PY': 'брызги',
            'PO': 'пыльный вихрь', 'SQ': 'шквал', 'FC': 'воронка', 'SS': 'песчаная буря', 'DS': 'пыльная буря'
        };
        const CLOUD_TYPES = {
            'FEW': 'малооблачная (1-2 октанта)', 'SCT': 'рассеянная (3-4 октанта)',
            'BKN': 'значительная (5-7 октантов)', 'OVC': 'сплошная (8 октантов)',
            'NSC': 'нет значительной облачности', 'SKC': 'ясно', 'CLR': 'ясно (автомат)',
            '///': 'неизвестно'
        };
        const CLOUD_SUFFIX = { 'CB': 'кучево-дождевые', 'TCU': 'мощные кучевые' };

        /* Full METAR parser (kept from original). Returns a human-readable string. */
        function parseMetar(metar) {
            try {
                const parts = metar.trim().toUpperCase().replace(/=+$/,'').split(/\s+/);
                let i = 0;
                const out = [];
                if (parts[i] === 'METAR' || parts[i] === 'SPECI') { out.push(`Тип: ${parts[i]}`); i++; }
                if (/^[A-Z]{4}$/.test(parts[i])) {
                    out.push(`Аэродром: ${parts[i]}`);
                    i++;
                } else {
                    out.push('Ошибка: Неверный код аэродрома');
                }
                if (/^\d{6}Z$/.test(parts[i])) {
                    const d = parts[i];
                    out.push(`Время наблюдения: ${d.slice(0,2)} число, ${d.slice(2,4)}:${d.slice(4,6)} UTC`);
                    i++;
                } else {
                    out.push('Ошибка: Неверный формат времени');
                }
                if (parts[i] === 'AUTO') { out.push('Отчёт автоматический'); i++; }
                if (parts[i] === 'COR') { out.push('Отчёт исправленный'); i++; }
                const windRe = /^(VRB|\d{3}|\/\/\/)(\d{2,3})(G(\d{2,3}))?(KT|MPS|KMH)$/;
                if (windRe.test(parts[i])) {
                    const m = parts[i].match(windRe);
                    const dir = m[1] === 'VRB' ? 'переменного направления' : m[1] === '000' ? 'штиль' : `${m[1]}°`;
                    const speed = m[2];
                    const gust = m[4] ? `, порывы до ${m[4]} ${m[5]}` : '';
                    const unit = m[5] === 'KT' ? 'узлов' : m[5] === 'MPS' ? 'м/с' : 'км/ч';
                    out.push(`Ветер: ${dir}, ${speed} ${unit}${gust}`);
                    i++;
                } else if (parts[i]) {
                    out.push('Ошибка: Неверный формат ветра');
                    i++;
                }
                if (/^\d{3}V\d{3}$/.test(parts[i])) {
                    out.push(`Изменение направления ветра: от ${parts[i].slice(0,3)}° до ${parts[i].slice(5,8)}°`);
                    i++;
                }
                if (parts[i] === 'CAVOK') {
                    out.push('CAVOK — видимость ≥10 км, нет значимой погоды и облачности ниже 1500 м (5000 ft), нет CB/TCU');
                    i++;
                } else if (/^\d{4}$/.test(parts[i])) {
                    out.push(`Преобладающая видимость: ${parseInt(parts[i])} метров`);
                    i++;
                } else if (parts[i]) {
                    out.push('Ошибка: Неверный формат видимости');
                    i++;
                }
                while (/^R\d{2}[LCR]?\/.*/.test(parts[i])) {
                    const rvr = parts[i].match(/^R(\d{2}[LCR]?)\/(P|M)?(\d{4})(V(\d{4}))?(U|D|N)?$/);
                    if (rvr) {
                        let vis = rvr[3];
                        const prefix = rvr[2] === 'P' ? 'более ' : rvr[2] === 'M' ? 'менее ' : '';
                        const varVis = rvr[5] ? ` изменяется до ${rvr[5]}` : '';
                        const trend = rvr[6] === 'U' ? ' улучшается' : rvr[6] === 'D' ? ' ухудшается' : rvr[6] === 'N' ? ' без изменений' : '';
                        out.push(`RVR на ВПП ${rvr[1]}: ${prefix}${vis} м${varVis}${trend}`);
                    } else {
                        out.push(`Дальность видимости на ВПП: ${parts[i]}`);
                    }
                    i++;
                }
                while (/^[+-]?(VC)?(MI|BC|PR|DR|BL|SH|TS|FZ)?(DZ|RA|SN|SG|IC|PL|GR|GS|UP)?(BR|FG|FU|VA|DU|SA|HZ|PY)?(PO|SQ|FC|SS|DS)?$/.test(parts[i])) {
                    let code = parts[i];
                    let intensity = code[0] === '+' ? 'сильный ' : code[0] === '-' ? 'слабый ' : '';
                    if ('+-'.includes(code[0])) code = code.slice(1);
                    let descr = '', precip = '', obsc = '', other = '';
                    if (code.startsWith('VC')) { descr += 'в окрестностях '; code = code.slice(2); }
                    for (const key of ['MI','BC','PR','DR','BL','SH','TS','FZ']) if (code.startsWith(key)) { descr += WEATHER_CODES[key] + ' '; code = code.slice(key.length); }
                    for (const key of ['DZ','RA','SN','SG','IC','PL','GR','GS','UP']) if (code.startsWith(key)) { precip += WEATHER_CODES[key] + ' '; code = code.slice(key.length); }
                    for (const key of ['BR','FG','FU','VA','DU','SA','HZ','PY']) if (code.startsWith(key)) { obsc += WEATHER_CODES[key] + ' '; code = code.slice(key.length); }
                    for (const key of ['PO','SQ','FC','SS','DS']) if (code.startsWith(key)) { other += WEATHER_CODES[key] + ' '; code = code.slice(key.length); }
                    if (code) out.push('Ошибка: Неизвестный код погоды ' + parts[i]);
                    else out.push(`Текущая погода: ${intensity}${descr}${precip}${obsc}${other}`.trim());
                    i++;
                }
                while (/^(FEW|SCT|BKN|OVC|NSC|SKC|CLR|\/\/\/)\d{3}(CB|TCU|\/\/\/)?$/.test(parts[i]) || /^VV\d{3}$/.test(parts[i])) {
                    if (/^VV\d{3}$/.test(parts[i])) {
                        out.push(`Вертикальная видимость: ${parseInt(parts[i].slice(2))*30} м`);
                        i++;
                        continue;
                    }
                    const m = parts[i].match(/^(FEW|SCT|BKN|OVC|NSC|SKC|CLR|\/\/\/)(\d{3}|\/\/\/)(CB|TCU|\/\/\/)?$/);
                    const cov = CLOUD_TYPES[m[1]] || m[1];
                    const height = m[2] === '///' ? '' : `${parseInt(m[2])*30} м (${parseInt(m[2])*100} футов)`;
                    const type = m[3] && m[3] !== '///' ? CLOUD_SUFFIX[m[3]] : '';
                    out.push(`Облачность: ${cov}${height ? ', высота ' + height : ''}${type ? ', ' + type : ''}`);
                    i++;
                }
                if (/^(M?\d{2})\/(M?\d{2})$/.test(parts[i])) {
                    let [t, td] = parts[i].split('/');
                    t = t.startsWith('M') ? '-' + t.slice(1) : t;
                    td = td.startsWith('M') ? '-' + td.slice(1) : td;
                    out.push(`Температура воздуха: ${t}°C, точка росы: ${td}°C`);
                    i++;
                } else if (parts[i]) {
                    out.push('Ошибка: Неверный формат температуры');
                    i++;
                }
                if (/^[QA]\d{4}$/.test(parts[i])) {
                    if (parts[i].startsWith('Q')) {
                        out.push(`Давление QNH: ${parts[i].slice(1)} гПа`);
                    } else {
                        const inches = parts[i].slice(1,3) + '.' + parts[i].slice(3);
                        out.push(`Давление: ${inches} дюймов рт. ст.`);
                    }
                    i++;
                } else if (parts[i]) {
                    out.push('Ошибка: Неверный формат давления');
                    i++;
                }
                while (i < parts.length) {
                    if (parts[i].startsWith('RE')) {
                        out.push(`Недавняя погода: ${parseWeather(parts[i].slice(2))}`);
                        i++;
                    } else if (parts[i].startsWith('WS')) {
                        out.push(`Сдвиг ветра: ${parts[i]}`);
                        i++;
                    } else if (parts[i] === 'RMK') {
                        out.push(`Замечания: ${parts.slice(i+1).join(' ')}`);
                        break;
                    } else {
                        out.push(`Тренд или дополнительно: ${parts[i]}`);
                        i++;
                    }
                }
                return out.join('\n');
            } catch (e) {
                return 'Ошибка парсинга METAR: ' + e.message;
            }
        }

        function parseWeather(code) {
            return code.split(/(?=[A-Z]{2})/).map(c => WEATHER_CODES[c] || c).join(' ');
        }

        /* Helper: extract core fields from METAR into an object for games (wind, vis, temp, qnh) */
        function parseMetarFields(metar) {
            const parts = metar.trim().toUpperCase().replace(/=+$/,'').split(/\s+/);
            const out = { wind: '', vis: '', temp: '', qnh: '' };
            for (let i = 0; i < parts.length; i++) {
                if (/^(VRB|\d{3}|\/\/\/)\d{2,3}(G\d{2,3})?(KT|MPS|KMH)$/.test(parts[i])) {
                    out.wind = parts[i];
                    continue;
                }
            }
            const visMatch = parts.find(p => p === 'CAVOK' || /^\d{4}$/.test(p));
            out.vis = visMatch || '';
            const tempMatch = parts.find(p => /^(M?\d{2})\/(M?\d{2})$/.test(p));
            out.temp = tempMatch || '';
            const qMatch = parts.find(p => /^[QA]\d{4}$/.test(p));
            out.qnh = qMatch || '';
            return out;
        }

        /* ---------- Parsers for other code types (from original file) ---------- */
        function parseTaf(taf) {
            try {
                const parts = taf.trim().toUpperCase().split(/\s+/);
                let i = 0;
                const out = ['Прогноз погоды по аэродрому (TAF)'];
                if (parts[i] === 'TAF') i++;
                if (parts[i] === 'AMD' || parts[i] === 'COR') { out.push(`Статус: ${parts[i] === 'AMD' ? 'исправленный' : 'корректированный'}`); i++; }
                if (/^[A-Z]{4}$/.test(parts[i])) { out.push(`Аэродром: ${parts[i]}`); i++; }
                if (/^\d{6}Z/.test(parts[i])) {
                    const d = parts[i];
                    out.push(`Выпущен: ${d.slice(0,2)} число, ${d.slice(2,4)}:${d.slice(4,6)} UTC`);
                    i++;
                }
                if (/^\d{4}\/\d{4}$/.test(parts[i])) {
                    const [from, to] = parts[i].split('/');
                    out.push(`Действует: с ${from.slice(0,2)} ${from.slice(2)}:00 до ${to.slice(0,2)} ${to.slice(2)}:00 UTC`);
                    i++;
                }
                let temp = [];
                while (i < parts.length && !['FM','TEMPO','BECMG','PROB30','PROB40'].includes(parts[i])) {
                    temp.push(parts[i++]);
                }
                out.push('Основной прогноз:');
                out.push(parseMetar(temp.join(' ')));
                while (i < parts.length) {
                    let line = '';
                    let prob = '';
                    if (parts[i].startsWith('PROB')) {
                        prob = parts[i] + ' вероятность ';
                        i++;
                    }
                    const type = parts[i++];
                    if (type === 'FM') {
                        const time = parts[i++];
                        line += `${prob}С ${time.slice(0,2)} числа ${time.slice(2,4)}:${time.slice(4,6)} UTC: `;
                    } else if (type === 'TEMPO' || type === 'BECMG') {
                        const period = parts[i++];
                        const [f,t] = period.split('/');
                        line += `${prob}${type === 'TEMPO' ? 'Временно' : 'Становясь'} с ${f.slice(0,2)} ${f.slice(2)}:00 до ${t.slice(0,2)} ${t.slice(2)}:00: `;
                    }
                    temp = [];
                    while (i < parts.length && !['FM','TEMPO','BECMG','PROB30','PROB40'].includes(parts[i])) {
                        temp.push(parts[i++]);
                    }
                    out.push(line);
                    out.push(parseMetar(temp.join(' ')));
                }
                return out.join('\n');
            } catch (e) {
                return 'Ошибка парсинга TAF: ' + e.message;
            }
        }

        function parseKn01(kn01) {
            try {
                const groups = kn01.split(/\s+/);
                if (groups.length < 10) return 'Ошибка: Недостаточно групп в KN-01';
                let decoded = '';
                let i = 0;
                decoded += `• Станция: ${groups[i++]}\n`;
                decoded += `• Тип: ${groups[i++]}\n`;
                decoded += `• Облачность малая: ${groups[i++]}\n`;
                decoded += `• Облачность средняя/верхняя: ${groups[i++]}\n`;
                decoded += `• Нижняя облачность: ${groups[i++]}\n`;
                decoded += `• Давление на уровне станции: ${groups[i++]}\n`;
                decoded += `• Тенденция давления: ${groups[i++]}\n`;
                decoded += `• Осадки за 6 ч: ${groups[i++]}\n`;
                decoded += `• Осадки за 3 ч: ${groups[i++]}\n`;
                decoded += `• Погода в срок и между сроками: ${groups[i++]}\n`;
                while (i < groups.length) {
                    decoded += `• Дополнительно: ${groups[i++]}\n`;
                }
                return decoded;
            } catch (e) {
                return 'Ошибка парсинга KN-01: ' + e.message;
            }
        }

        function parseGamet(gamet) {
            try {
                const sections = gamet.split(/SEC\s+I:/);
                let decoded = '';
                decoded += '• Секция I: Опасности\n' + (sections[1] ? sections[1] : 'Нет данных');
                const sec2 = gamet.split(/SEC\s+II:/);
                decoded += '\n• Секция II: Прогноз по маршруту\n' + (sec2[1] ? sec2[1] : 'Нет данных');
                return decoded;
            } catch (e) {
                return 'Ошибка парсинга GAMET: ' + e.message;
            }
        }

        function parseSigmet(sigmet) {
            try {
                const groups = sigmet.split(/\s+/);
                if (groups.length < 5) return 'Ошибка: Недостаточно групп в SIGMET';
                let decoded = '';
                let i = 0;
                decoded += `• Тип: ${groups[i++]}\n`;
                decoded += `• FIR: ${groups[i++]}\n`;
                while (i < groups.length) {
                    if (groups[i] === 'VALID') {
                        decoded += `• Действует: ${groups[++i]}\n`;
                        i++;
                    } else if (groups[i].match(/TS|CB|TURB|ICE|VA|MTW/)) {
                        decoded += `• Феномен: ${groups[i]}\n`;
                        i++;
                    } else if (groups[i] === 'OBS') decoded += `• Наблюдается: ${groups[++i]}\n`;
                    else if (groups[i] === 'FCST') decoded += `• Прогноз: ${groups[++i]}\n`;
                    else if (groups[i] === 'MOV') decoded += `• Движение: ${groups[++i]} ${groups[++i]}\n`;
                    else i++;
                }
                return decoded;
            } catch (e) {
                return 'Ошибка парсинга SIGMET: ' + e.message;
            }
        }

        function parseWarep(warep) {
            try {
                const groups = warep.split(/\s+/);
                if (groups.length < 3) return 'Ошибка: Недостаточно групп в WAREP';
                let decoded = '';
                let i = 0;
                if (groups[i] === 'WAREP') i++;
                decoded += `• Тип репорта: ${groups[i++]}\n`;
                decoded += parseMetar(groups.slice(i).join(' '));
                return decoded;
            } catch (e) {
                return 'Ошибка парсинга WAREP: ' + e.message;
            }
        }

        function parseKn04(kn04) {
            try {
                const groups = kn04.split(/\s+/);
                if (groups.length < 4) return 'Ошибка: Недостаточно групп в KN-04';
                let decoded = '';
                let i = 0;
                decoded += `• Тип предупреждения: ${groups[i++]}\n`;
                decoded += `• Зона: ${groups[i++]}\n`;
                const timeMatch = groups[i]?.match(/VALID (\d{6})\/(\d{6})/);
                if (timeMatch) {
                    decoded += `• Действует с ${timeMatch[1]} до ${timeMatch[2]}\n`;
                    i++;
                }
                while (i < groups.length) {
                    if (groups[i].match(/WIND|RAIN|STORM|TS|GR|SQ/)) decoded += `• Феномен: ${groups[i]}\n`;
                    i++;
                }
                return decoded;
            } catch (e) {
                return 'Ошибка парсинга KN-04: ' + e.message;
            }
        }

        function parseAirmet(airmet) {
            try {
                const groups = airmet.split(/\s+/);
                if (groups.length < 5) return 'Ошибка: Недостаточно групп в AIRMET';
                let decoded = '';
                let i = 0;
                decoded += `• Тип: AIRMET ${groups[i++]}\n`;
                decoded += `• FIR: ${groups[i++]}\n`;
                while (i < groups.length) {
                    if (groups[i] === 'VALID') decoded += `• Действует: ${groups[++i]}\n`;
                    else if (groups[i].match(/MTN|OBSC|ICG|TURB|WIND|MOD|ICE|BKN|CLD|SFC|VIS|ISOL|TS|OCNL|RA/)) decoded += `• Феномен (умеренный): ${groups[i]}\n`;
                    i++;
                }
                return decoded;
            } catch (e) {
                return 'Ошибка парсинга AIRMET: ' + e.message;
            }
        }

        /* ---------- UI initialization for trainer (from original) ----------
           Modified: when user selects specific code types, show "В разработке" message.
        */
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize encode exercise and trainer stats
            newEncodeExercise();
            updateTrainerStats();

            // Types that are currently under development
            const devTypes = ['kn01', 'taf', 'gamet', 'sigmet', 'warep', 'kn04', 'airmet'];

            // code type selector handlers
            document.querySelectorAll('.code-type-selector .code-type-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    // default UI: hide dev message, show mode-selector and input-section
                    const devMessageEl = document.getElementById('dev-message');
                    const modeSelectorEl = document.querySelector('.mode-selector');
                    const inputSectionEl = document.querySelector('.input-section');

                    // update active button visuals
                    document.querySelectorAll('.code-type-selector .code-type-btn').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');

                    // determine selected type
                    const type = this.dataset.type;

                    // If selected type is in devTypes, show "В разработке" and hide main trainer UI
                    if (devTypes.includes(type)) {
                        if (modeSelectorEl) modeSelectorEl.style.display = 'none';
                        if (inputSectionEl) inputSectionEl.style.display = 'none';
                        if (devMessageEl) {
                            devMessageEl.style.display = 'block';
                            devMessageEl.textContent = 'В разработке';
                        }
                        // Update sidebar hints to inform user
                        if (document.getElementById('sidebar-hints')) {
                            document.getElementById('sidebar-hints').innerHTML = `<strong>${type.toUpperCase()}</strong> — Модуль находится в разработке.`;
                        }
                        return;
                    }
                    if (modeSelectorEl) modeSelectorEl.style.display = '';
                    if (inputSectionEl) inputSectionEl.style.display = '';
                    if (devMessageEl) devMessageEl.style.display = 'none';

                    const info = codeInstructions[type];
                    if (info) {
                        document.getElementById('decode-instructions').innerHTML = info.decode;
                        document.getElementById('sidebar-hints').innerHTML = `<strong>${info.title}</strong><br><br>` + info.hints.replace(/\n/g, '<br>');
                    }
                });
            });

            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.mode-btn').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                    const mode = this.dataset.mode;
                    document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(mode + '-content').classList.add('active');
                });
            });

            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
            }

            initTopMenu();

            initGameSelector();

            if (document.getElementById('score')) updateStats();
        });

        const codeInstructions = {
            metar: {
                title: "METAR / SPECI",
                decode: `<strong>Режим авторасшифровки METAR:</strong><br>Вставьте код — получите полную расшифровку.<br>
                         Поддерживается: ветер, видимость, RVR, погода, облачность, температура, давление, тренд, RMK.`,
                hints: `• ICAO код аэродрома<br>
                        • День и время (Z)<br>
                        • Ветер: 05007MPS или 18015G25KT<br>
                        • Видимость: 9999, 6000, CAVOK<br>
                        • Погода: RA, TS, +SHRA<br>
                        • Облачность: BKN020CB<br>
                        • Температура/точка росы: 15/12 или M02/M04<br>
                        • Q1013, A2992<br>
                        • NOSIG, BECMG, TEMPO`
            },
            kn01: {
                title: "КН-01 (Синоптический код)",
                decode: `<strong>КН-01 — наземные метеонаблюдения</strong><br>Расшифровка по группам: идентификатор, ветер, видимость, облачность, температура, давление и т.д.`,
                hints: `• 34580 — индекс станции<br>
                        • 11012 — облачность малая<br>
                        • 21089 — облачность средняя/верхняя<br>
                        • 30012 — нижняя облачность<br>
                        • 40123 — давление на уровне станции<br>
                        • 52015 — тенденция давления<br>
                        • 60022 — осадки за 6 ч<br>
                        • 70033 — осадки за 3 ч<br>
                        • 91012 — погода в срок и между сроками`
            },
            taf: {
                title: "TAF (Прогноз по аэродрому)",
                decode: `<strong>TAF — прогноз погоды</strong><br>Включает период действия, изменения FM, TEMPO, BECMG, PROB.`,
                hints: `• TAF AMD, COR<br>
                        • Период: 151200/161200<br>
                        • FM151300 — с 13:00<br>
                        • TEMPO 1514/1518 — временно<br>
                        • BECMG 1520/1522 — постепенное изменение<br>
                        • PROB30, PROB40 — вероятность`
            },
            gamet: {
                title: "GAMET (Прогноз для низких уровней)",
                decode: `<strong>GAMET — прогноз опасных явлений</strong><br>Секции: SEC I (опасности), SEC II (прогноз по маршруту).`,
                hints: `• VA — вулканический пепел<br>
                        • TC — тропический циклон<br>
                        • TURB, ICE, MTW<br>
                        • SFC WIND, VIS, SIG CLD<br>
                        • FL050-100 — уровень`
            },
            sigmet: {
                title: "SIGMET (Значительное явление)",
                decode: `<strong>SIGMET — предупреждение о значительных явлениях</strong><br>TS, TC, TURB, ICE, VA, MTW и др.`,
                hints: `• WS — SIGMET по ветру<br>
                        • WV — по турбулентности<br>
                        • WC — по обледенению<br>
                        • VALID 151200/151600<br>
                        • VA ERUPTION, TC NAME<br>
                        • OBS, FCST, MOV E 30KT`
            },
            airmet: {
                title: "AIRMET (Умеренные явления)",
                decode: `<strong>AIRMET — умеренные явления</strong><br>Аналог SIGMET, но менее интенсивные.`,
                hints: `• MOD TURB, MOD ICE<br>
                        • MT OBSC, BKN CLD<br>
                        • SFC VIS <5000M<br>
                        • ISOL TS, OCNL RA`
            },
            kn04: {
                title: "КН-04 (Штормовое предупреждение)",
                decode: `<strong>КН-04 — штормовое предупреждение по району</strong><br>Для метеорологических районов РФ.`,
                hints: `• VALID 151200/152400<br>
                        • WIND 20020MPS G35MPS<br>
                        • VIS 1000M RA<br>
                        • TS, GR, SQ<br>
                        • Район: Северо-Запад, Урал и т.д.`
            },
            warep: {
                title: "WAREP (Особый репорт)",
                decode: `<strong>WAREP — особый репорт пилота</strong><br>О турбулентности, обледенении, вулканическом пепле.`,
                hints: `• TURB SEV, ICE MOD<br>
                        • VA OBS, TC REPORT<br>
                        • FL180, POSITION<br>
                        • TIME 1230Z`
            }
        };

        /* ---------- UI & helpers for trainer (decode/check/encode) ---------- */
        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }

        function toggleAccordion(element) {
            const expanded = element.getAttribute('aria-expanded') === 'true';
            element.setAttribute('aria-expanded', !expanded);
            const panel = element.nextElementSibling;
            panel.style.display = expanded ? 'none' : 'block';
        }

        function decodeCode() {
            document.getElementById('loading-decode').style.display = 'block';
            setTimeout(() => {
                const input = document.getElementById('metar-input').value.trim().toUpperCase();
                const resultDiv = document.getElementById('decode-result');
                const codeType = document.querySelector('.code-type-btn.active').dataset.type;
                let decoded = '';
                if (codeType === 'metar') decoded = parseMetar(input);
                else if (codeType === 'taf') decoded = parseTaf(input);
                else if (codeType === 'kn01') decoded = parseKn01(input);
                else if (codeType === 'gamet') decoded = parseGamet(input);
                else if (codeType === 'sigmet') decoded = parseSigmet(input);
                else if (codeType === 'warep') decoded = parseWarep(input);
                else if (codeType === 'kn04') decoded = parseKn04(input);
                else if (codeType === 'airmet') decoded = parseAirmet(input);
                resultDiv.textContent = decoded || 'Ошибка: Пожалуйста, введите код';
                resultDiv.className = decoded.startsWith('Ошибка') ? 'result error' : 'result';
                document.getElementById('loading-decode').style.display = 'none';
            }, 500);
        }

        function checkDecode() {
            document.getElementById('loading-practice-decode').style.display = 'block';
            setTimeout(() => {
                const userAnswer = document.getElementById('user-decode').value.trim().toLowerCase();
                const resultDiv = document.getElementById('practice-decode-result');
                const comparisonDiv = document.getElementById('decode-comparison');
                if (!userAnswer) {
                    resultDiv.textContent = 'Ошибка: Введите вашу расшифровку';
                    resultDiv.className = 'result error';
                    document.getElementById('loading-practice-decode').style.display = 'none';
                    return;
                }
                currentPracticeCode = document.getElementById('practice-code').textContent.trim();
                const codeType = document.querySelector('.code-type-btn.active').dataset.type;
                let correctDecoded = '';
                if (codeType === 'metar') {
                    correctDecoded = parseMetar(currentPracticeCode).toLowerCase();
                } else if (codeType === 'taf') {
                    correctDecoded = parseTaf(currentPracticeCode).toLowerCase();
                } else if (codeType === 'kn01') {
                    correctDecoded = parseKn01(currentPracticeCode).toLowerCase();
                } else if (codeType === 'gamet') {
                    correctDecoded = parseGamet(currentPracticeCode).toLowerCase();
                } else if (codeType === 'sigmet') {
                    correctDecoded = parseSigmet(currentPracticeCode).toLowerCase();
                } else if (codeType === 'warep') {
                    correctDecoded = parseWarep(currentPracticeCode).toLowerCase();
                } else if (codeType === 'kn04') {
                    correctDecoded = parseKn04(currentPracticeCode).toLowerCase();
                } else if (codeType === 'airmet') {
                    correctDecoded = parseAirmet(currentPracticeCode).toLowerCase();
                }
                const userLines = userAnswer.split('\n').map(line => line.trim()).filter(line => line);
                const correctLines = correctDecoded.split('\n').map(line => line.trim()).filter(line => line);
                let matchCount = 0;
                correctLines.forEach((correct, idx) => {
                    if (userLines[idx] && userLines[idx].includes(correct)) matchCount++;
                });
                const accuracy = (matchCount / correctLines.length) * 100;
                if (accuracy > 80) {
                    resultDiv.textContent = 'Отлично! Расшифровка верная! (Точность: ' + accuracy.toFixed(0) + '%)';
                    resultDiv.className = 'result success';
                    comparisonDiv.style.display = 'none';
                    trainerStats.correctDecoded++;
                    trainerStats.sessionCorrect++;
                } else {
                    resultDiv.textContent = 'Есть ошибки. Точность: ' + accuracy.toFixed(0) + '%. Сравните с правильной расшифровкой:';
                    resultDiv.className = 'result error';
                    displayLineComparison(userLines, correctLines, 'decode');
                    comparisonDiv.style.display = 'grid';
                    const codeTypeKey = document.querySelector('.code-type-btn.active').dataset.type;
                    trainerStats.errorsByType[codeTypeKey]++;
                }
                trainerStats.totalDecoded++;
                trainerStats.sessionDecoded++;
                updateTrainerStats();
                try { gtag('event', 'check_decode', { 'accuracy': accuracy }); } catch(e){}
                document.getElementById('loading-practice-decode').style.display = 'none';
            }, 500);
        }

     function displayLineComparison(userLines, correctLines, mode) {
            const userDisplay = document.getElementById(mode === 'decode' ? 'user-decode-display' : 'user-answer-display');
            const correctDisplay = document.getElementById(mode === 'decode' ? 'correct-decode-display' : 'correct-answer-display');
            userDisplay.innerHTML = '';
            correctDisplay.innerHTML = '';
            const maxLen = Math.max(userLines.length, correctLines.length);
            for (let i = 0; i < maxLen; i++) {
                const userSpan = document.createElement('div');
                const correctSpan = document.createElement('div');
                userSpan.textContent = userLines[i] || '';
                correctSpan.textContent = correctLines[i] || '';
                userSpan.classList.add('comparison-group');
                correctSpan.classList.add('comparison-group');
                if (userLines[i] === correctLines[i]) {
                    userSpan.classList.add('correct');
                    correctSpan.classList.add('correct');
                } else {
                    userSpan.classList.add('incorrect');
                    correctSpan.classList.add('incorrect');
                }
                userDisplay.appendChild(userSpan);
                correctDisplay.appendChild(correctSpan);
            }
        }

        function newEncodeExercise() {
            const randomIndex = Math.floor(Math.random() * weatherDatabase.length);
            currentEncodeExercise = weatherDatabase[randomIndex];
            document.getElementById('weather-description').textContent = currentEncodeExercise.description;
            document.getElementById('user-encode').value = '';
            document.getElementById('practice-encode-result').textContent = 'Результат проверки кодирования...';
            document.getElementById('practice-encode-result').className = 'result';
            document.getElementById('encode-comparison').style.display = 'none';
            document.getElementById('encode-hint').style.display = 'none';
            hintStep = 0;
            document.getElementById('next-hint-btn').style.display = 'none';
        }

        function checkEncode() {
            document.getElementById('loading-practice-encode').style.display = 'block';
            setTimeout(() => {
                const userCode = document.getElementById('user-encode').value.trim();
                const resultDiv = document.getElementById('practice-encode-result');
                const comparisonDiv = document.getElementById('encode-comparison');
                const codeType = document.querySelector('.code-type-btn.active').dataset.type;
                if (!userCode) {
                    resultDiv.textContent = 'Ошибка: Введите ваш код';
                    resultDiv.className = 'result error';
                    document.getElementById('loading-practice-encode').style.display = 'none';
                    return;
                }
                if (!currentEncodeExercise) {
                    resultDiv.textContent = 'Ошибка: Сначала выберите задание';
                    resultDiv.className = 'result error';
                    document.getElementById('loading-practice-encode').style.display = 'none';
                    return;
                }
                const normalizeCode = code => code.trim().toUpperCase().replace(/\s+/g, ' ').replace(/=+$/, '');
                const userNorm = normalizeCode(userCode);
                const correctNorm = normalizeCode(currentEncodeExercise.code);
                const userGroups = userNorm.split(' ');
                const correctGroups = correctNorm.split(' ');
                let feedback = '';
                let errorCount = 0;
                for (let j = 0; j < Math.max(userGroups.length, correctGroups.length); j++) {
                    if (userGroups[j] !== correctGroups[j]) {
                        let errorDetail = '';
                        if (j === 0 && correctGroups[j] === 'METAR' && codeType === 'metar') errorDetail = ' (Ожидается тип отчёта METAR)';
                        if (j === 2 && !userGroups[j]?.match(/^\d{3}\d{2,3}(G\d{2,3})?(MPS|KT)$/)) errorDetail = ' (Неверный формат ветра: направление° скорость [порывы] единица)';
                        if (j === correctGroups.length - 1 && correctGroups[j] === 'NOSIG') errorDetail = ' (Забыли NOSIG - без изменений)';
                        if (j === 5 && !userGroups[j]?.match(/^(M?\d{2})\/(M?\d{2})$/)) errorDetail = ' (Неверный формат температуры: T/TD)';
                        feedback += `• Ошибка в группе ${j+1}: Ожидалось ${correctGroups[j] || 'отсутствует'}, введено ${userGroups[j] || 'отсутствует'}${errorDetail}\n`;
                        errorCount++;
                    }
                }
                if (errorCount === 0) {
                    resultDiv.textContent = 'Отлично! Код закодирован верно!';
                    resultDiv.className = 'result success';
                    comparisonDiv.style.display = 'none';
                    trainerStats.correctDecoded++;
                    trainerStats.sessionCorrect++;
                } else {
                    resultDiv.textContent = 'Есть ошибки в кодировании. Детали:\n' + feedback;
                    resultDiv.className = 'result error';
                    displayLineComparison(userGroups, correctGroups, 'encode');
                    comparisonDiv.style.display = 'grid';
                    const codeTypeKey = document.querySelector('.code-type-btn.active').dataset.type;
                    trainerStats.errorsByType[codeTypeKey]++;
                }
                trainerStats.totalDecoded++;
                trainerStats.sessionDecoded++;
                updateTrainerStats();
                try { gtag('event', 'check_encode', { 'success': errorCount === 0 }); } catch(e){}
                document.getElementById('loading-practice-encode').style.display = 'none';
            }, 500);
        }

        function showEncodeHint() {
            if (!currentEncodeExercise) return;
            hintStep = 1;
            updateHint();
            document.getElementById('next-hint-btn').style.display = 'inline-block';
        }

        function showNextHint() {
            hintStep++;
            updateHint();
        }

        function updateHint() {
            const code = currentEncodeExercise.code.trim();
            const groups = code.split(/\s+/);
            let hint = '';
            for (let i = 0; i < groups.length; i++) {
                if (i < hintStep) {
                    hint += groups[i] + ' ';
                } else {
                    hint += '-'.repeat(groups[i].length) + ' ';
                }
            }
            document.getElementById('encode-hint').textContent = hint.trim();
            document.getElementById('encode-hint').style.display = 'block';
            if (hintStep >= groups.length) {
                document.getElementById('next-hint-btn').style.display = 'none';
            }
        }

        function newPracticeCode() {
            const codes = {
                metar: ['UUWW 141630Z 05007MPS 9999 SCT020 17/12 Q1011 NOSIG', 'UUDD 141600Z 03005MPS 9999 BKN015 15/10 Q1012'],
                taf: ['TAF UUWW 141600Z 1418/1524 03005MPS 9999 BKN015 TX15/1412Z TN10/1503Z'],
                kn01: ['KN01 34580 11012 21089 30012 40123 52015 60022 70033 80044 91012'],
                gamet: ['GAMET VALID 151200/151800 UUEE SEC I: TURB MOD FL050-100 SEC II: SFC VIS 5000 RA'],
                sigmet: ['SIGMET 1 VALID 151200/151600 UUEE TS OBS AT 1200Z N OF N55 MOV E 30KT'],
                warep: ['WAREP TURB SEV FL180 TIME 1230Z POSITION 55N030E'],
                kn04: ['KN04 WARNING VALID 151200/152400 WIND 20020MPS G35MPS'],
                airmet: ['AIRMET 1 VALID 151200/151600 UUEE MOD TURB FL050-100']
            };
            const codeType = document.querySelector('.code-type-btn.active').dataset.type;
            const typeCodes = codes[codeType] || codes.metar;
            const randomCode = typeCodes[Math.floor(Math.random() * typeCodes.length)];
            document.getElementById('practice-code').textContent = randomCode;
            document.getElementById('user-decode').value = '';
            document.getElementById('practice-decode-result').textContent = 'Результат проверки...';
            document.getElementById('practice-decode-result').className = 'result';
            document.getElementById('decode-comparison').style.display = 'none';
        }

        function clearFields() {
            document.getElementById('metar-input').value = '';
            document.getElementById('decode-result').textContent = 'Здесь появится расшифровка кода...';
            document.getElementById('decode-result').className = 'result';
        }

        function copyCode(elementId) {
            const el = document.getElementById(elementId);
            const text = (el.value !== undefined) ? el.value : el.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Код скопирован!');
            }).catch(err => {
                console.error('Ошибка копирования: ', err);
            });
        }

        function updateTrainerStats() {
            const percent = trainerStats.sessionDecoded > 0 ? Math.round((trainerStats.sessionCorrect / trainerStats.sessionDecoded) * 100) : 0;
            document.getElementById('trainer-level').textContent = trainerStats.level;
            document.getElementById('decoded-count').textContent = trainerStats.sessionDecoded;
            document.getElementById('correct-percent').textContent = percent + '%';
            document.getElementById('level-progress').value = trainerStats.totalDecoded % 50;
            const badge = percent > 90 ? 'Эксперт' : percent > 70 ? 'Профи' : 'Новичок';
            document.getElementById('badge').textContent = `Бейдж: ${badge}`;
            const errorsList = document.getElementById('errors-by-type');
            errorsList.innerHTML = '';
            for (const type in trainerStats.errorsByType) {
                const li = document.createElement('li');
                li.textContent = `${type.toUpperCase()}: ${trainerStats.errorsByType[type]}`;
                errorsList.appendChild(li);
            }
            if (trainerStats.totalDecoded >= trainerStats.level * 50) {
                trainerStats.level++;
            }
            localStorage.setItem('trainerStats', JSON.stringify(trainerStats));
        }

        function resetStats() {
            if (confirm('Сбросить статистику?')) {
                trainerStats = {"level":1,"totalDecoded":0,"correctDecoded":0,"sessionDecoded":0,"sessionCorrect":0,"errorsByType":{"metar":0,"kn01":0,"taf":0,"gamet":0,"sigmet":0,"warep":0,"kn04":0,"airmet":0}};
                localStorage.setItem('trainerStats', JSON.stringify(trainerStats));
                updateTrainerStats();
            }
        }

        /* ------------- Minigames code (from Игра тест 7.html) ------------- */
        // Game data (kept as in original)
        const gameData = {
            METAR: {
                easy: [
                    {code:"METAR UBBB 251600Z 27005MPS 9999 RA FEW030 20/16 Q1012 NOSIG=", errors:[3], hint:"Видимость"},
                    {code:"METAR UUEE 251600Z 00000KT 9999 SCT040 15/10 Q1018", errors:[1], hint:"KT или MPS?"}
                ],
                medium: [
                    {code:"METAR ULLI 251630Z 18007MPS 8000 -RA BKN007 OVC030 03/M01 Q1002 NOSIG", errors:[2,6], hint:"Видимость и облачность"},
                    {code:"METAR LFPG 251700Z 22012KT 9999 SCT025 BKN100 18/12 A1014", errors:[8], hint:"Давление"}
                ],
                hard: [
                    {code:"METAR KJFK 251651Z 18007KT 10SM FEW040 BKN070 OVC100 18/14 A3005 RMK AO2 SLP141", errors:[1], hint1:"Проверь единицы ветра", hint2:"Формат видимости"},
                    {code:"METAR EGLL 251650Z 24015G25KT 9999 RA BKN008 OVC015 12/10 Q0998 TEMPO SHRA", errors:[4,9], hint1:"RA и SHRA — разные", hint2:"Проверь облачность"}
                ]
            },
            TAF: {
                easy: [
                    {code:"TAF UBBB 2517/2618 27005KT 9999 SCT030", errors:[1], hint:"Формат времени в TAF!"},
                    {code:"TAF UUEE 251720Z 2518/2618 00000MPS 9999", errors:[2], hint:"ветер в прогнозе?"}
                ],
                medium: [
                    {code:"TAF AMD LFPG 2517/2624 22010KT 6000 RA BKN012", errors:[0], hint:"AMD — только при коррекции!"},
                    {code:"TAF COR ULLI 2518/2618 VRB03MPS 8000 BKN020", errors:[3], hint:"Проверь видимость"}
                ],
                hard: [
                    {code:"TAF KJFK 251720Z 2518/2624 18010KT P6SM SKC BECMG 2520/2522 20015G25KT", errors:[1], hint1:"Ошибка в времени?", hint2:"Формат видимости"},
                    {code:"TAF EGLL 251750Z 2518/2624 24012KT 9999 BKN014 PROB30 TEMPO 2520/2522 7000 SHRA", errors:[5], hint1:"Проверь вероятность", hint2:"Видимость в TEMPO"}
                ]
            },
            GAMET: {
                easy: [
                    {code:"GAMET LGGG 251500/252100 AMD 1500Z 1. SIGWX 2. SFC VIS 3. SFC WIND", errors:[2], hint:"Формат времени!"}
                ],
                medium: [
                    {code:"GAMET LGGG 251500/252100 1. SIGWX TS 2. SFC VIS 5000 3. SFC WIND 27010KT", errors:[1,3], hint:"SIGWX и ветер"}
                ],
                hard: [
                    {code:"GAMET LGGG 251500/252100 1. SIGWX ISOL TS 2. SFC VIS 8000 3. SFC WIND 27010KT 4. CLD BKN030", errors:[2,4], hint1:"Видимость и облачность", hint2:"Формат разделов"}
                ]
            },
            SIGMET: {
                easy: [
                    {code:"SIGMET 1 VALID 251600/252000 LGGG- LGGG ATHINAI FIR SEV TURB FCST N OF N4000 FL300/400 MOV E 20KT NC=", errors:[0], hint:"Номер SIGMET"}
                ],
                medium: [
                    {code:"SIGMET 2 VALID 251600/252000 LGGG- LGGG ATHINAI FIR OBSC TS FCST S OF N4000 FL250/350 MOV NE 15KT WKN=", errors:[2,3], hint:"Явление и уровни"}
                ],
                hard: [
                    {code:"SIGMET 3 VALID 251600/252000 LGGG- LGGG ATHINAI FIR SEV ICE FCST N OF N3500 AND W OF E02000 FL100/200 MOV S 10KT INTSF=", errors:[4,5], hint1:"Локация и движение", hint2:"Интенсивность"}
                ]
            },
            WAREP: {
                easy: [
                    {code:"WAREP UUEE 251600Z 27005MPS 9999 FEW030=", errors:[0], hint:"Формат заголовка"}
                ],
                medium: [
                    {code:"WAREP UUEE 251600Z 00000KT 9999 SCT040=", errors:[1,3], hint:"Ветер и облачность"}
                ],
                hard: [
                    {code:"WAREP UUEE 251600Z 18007KT 8000 -RA BKN007 OVC030=", errors:[3,5], hint1:"Видимость и облачность", hint2:"Явление"}
                ]
            },
            'КН-01': {
                easy: [
                    {code:"КН-01 12345 251600Z 11111 22222 33333=", errors:[0], hint:"Формат кода"}
                ],
                medium: [
                    {code:"КН-01 12345 251600Z 99999 88888 77777=", errors:[3,4], hint:"Группы"}
                ],
                hard: [
                    {code:"КН-01 12345 251600Z 11111 22222 33333 44444 55555=", errors:[2,5], hint1:"Вторая группа", hint2:"Пятая группа"}
                ]
            },
            'КН-04': {
                easy: [
                    {code:"КН-04 67890 251600Z AAAAA BBBBB CCCCC=", errors:[2], hint:"Формат времени"}
                ],
                medium: [
                    {code:"КН-04 67890 251600Z 99999 88888 77777=", errors:[3,4], hint:"Группы"}
                ],
                hard: [
                    {code:"КН-04 67890 251600Z AAAAA BBBBB CCCCC DDDDD EEEEE=", errors:[4,5], hint1:"Четвертая группа", hint2:"Пятая группа"}
                ]
            },
            SPECI: {
                easy: [
                    {code:"SPECI UBBB 251600Z 27005MPS 5000 RA FEW030 20/16 Q1012=", errors:[4], hint:"Явление"}
                ],
                medium: [
                    {code:"SPECI UUEE 251600Z 00000KT 3000 BR SCT040 15/10 Q1018=", errors:[3,5], hint:"Видимость и температура"}
                ],
                hard: [
                    {code:"SPECI ULLI 251630Z 18007MPS 2000 +RA BKN007 OVC030 03/M01 Q1002=", errors:[2,6], hint1:"Видимость", hint2:"Облачность"}
                ]
            },
            AIRMET: {
                easy: [
                    {code:"AIRMET 1 VALID 251600/252000 LGGG- LGGG ATHINAI FIR MT OBSC FCST N OF N4000 FL050/150=", errors:[0], hint:"Номер AIRMET"}
                ],
                medium: [
                    {code:"AIRMET 2 VALID 251600/252000 LGGG- LGGG ATHINAI FIR SFC VIS 5000 BR FCST S OF N4000=", errors:[5,6], hint:"Видимость и явление"}
                ],
                hard: [
                    {code:"AIRMET 3 VALID 251600/252000 LGGG- LGGG ATHINAI FIR MOD TURB FCST N OF N3500 FL100/200 MOV E 10KT NC=", errors:[3,7], hint1:"Явление", hint2:"Движение"}
                ]
            }
        };

        const guessGameData = {
            metar: [
                {desc: "дымка", code: "BR"},
                {desc: "слабый дождь", code: "-RA"},
                {desc: "ливневый дождь", code: "SHRA"},
                {desc: "туман", code: "FG"},
                {desc: "без значительных изменений", code: "NOSIG"},
                {desc: "рассеянная облачность", code: "SCT"},
                {desc: "сплошная облачность", code: "OVC"}
            ]
        };

        const speedDecodeData = [
            "UUWW 141630Z 05007MPS 9999 SCT020 17/12 Q1011 NOSIG",
            "UUDD 141600Z 03005MPS 9999 BKN015 15/10 Q1012",
            "URSS 141630Z 00000MPS CAVOK 20/15 Q1010",
            "KMSN 150153Z 14007KT 10SM SCT100 BKN120 M01/M07 A3008 RMK AO2 SLP198",
            "EGLL 251650Z VRB03KT 9999 FEW030 15/10 Q1018 NOSIG",
            "ULLI 021930Z 00000MPS CAVOK 02/00 Q1032 R88/090060 NOSIG"
        ];

        const codeBuilderData = [
            {description: "Аэропорт Внуково, 14 число, 16:30 UTC, ветер 050° 7 м/с, видимость 10+ км, рассеянная облачность на 2000 футов, температура 17°C, точка росы 12°C, давление 1011 гПа, без изменений", code: "UUWW 141630Z 05007MPS 9999 SCT020 17/12 Q1011 NOSIG"},
            {description: "Аэропорт Домодедово, 14 число, 16:00 UTC, ветер 030° 5 м/с, видимость 10+ км, разорванная облачность на 1500 футах, температура 15°C, точка росы 10°C, давление 1012 гПа", code: "UUDD 141600Z 03005MPS 9999 BKN015 15/10 Q1012"},
            {description: "Аэропорт Сочи, 14 число, 16:30 UTC, штиль, CAVOK, температура 20°C, точка росы 15°C, давление 1010 гПа", code: "URSS 141630Z 00000MPS CAVOK 20/15 Q1010"},
            {description: "Аэропорт Пулково, 02 число, 19:30 UTC, штиль, CAVOK, температура 02°C, точка росы 00°C, давление 1032 гПа, RMK R88/090060, без изменений", code: "ULLI 021930Z 00000MPS CAVOK 02/00 Q1032 R88/090060 NOSIG"},
            {description: "Аэропорт Хитроу, 25 число, 16:50 UTC, ветер переменный 3 узла, видимость 10+ км, малооблачно на 3000 футах, температура 15°C, точка росы 10°C, давление 1018 гПа, без изменений", code: "EGLL 251650Z VRB03KT 9999 FEW030 15/10 Q1018 NOSIG"}
        ];

        const quizQuestions = [
            {question: "Что значит SCT040?", options: ["Рассеянная облачность на 4000 футов", "Сплошная", "Разорванная", "Малооблачно"], correct: 0},
            {question: "Код для тумана", options: ["BR", "HZ", "FG", "FU"], correct: 2},
            {question: "Что значит CAVOK?", options: ["Видимость >10км, без погоды", "Облачность", "Ветер", "Давление"], correct: 0},
            {question: "Код для грозы", options: ["TS", "RA", "SN", "FG"], correct: 0},
            {question: "Что значит NOSIG?", options: ["Без изменений", "С изменениями", "Прогноз", "Ошибка"], correct: 0},
            {question: "Код для снега", options: ["SN", "RA", "DZ", "BR"], correct: 0}
        ];

        const tafPredictorData = [
            {metar: "UUWW 141630Z 05007MPS 9999 SCT020 17/12 Q1011 NOSIG", taf: "TAF UUWW 141600Z 1418/1524 03005MPS 9999 BKN015 TX15/1412Z TN10/1503Z", question: "Какая минимальная температура ожидается?", answer: "10"},
            {metar: "UUDD 141600Z 03005MPS 9999 BKN015 15/10 Q1012", taf: "TAF UUDD 141500Z 1416/1518 04006MPS 8000 OVC010 TEMPO 1418/1506 3000 BR BKN005", question: "Будет ли туман?", answer: "Да"},
            {metar: "URSS 141630Z 00000MPS CAVOK 20/15 Q1010", taf: "TAF URSS 141600Z 1418/1524 VRB02MPS 9999 FEW030", question: "Изменится ли ветер?", answer: "Нет"},
            {metar: "ULLI 021930Z 00000MPS CAVOK 02/00 Q1032 R88/090060 NOSIG", taf: "TAF ULLI 021800Z 0219/0321 35004MPS 9999 BKN020", question: "Какая облачность ожидается?", answer: "BKN020"},
            {metar: "EGLL 251650Z VRB03KT 9999 FEW030 15/10 Q1018 NOSIG", taf: "TAF EGLL 251600Z 2518/2624 20005KT 9999 SCT025 PROB30 TEMPO 2600/2609 BKN010", question: "Вероятность низкой облачности?", answer: "30%"}
        ];

        const flightPlannerData = [
            {route: "UUWW: METAR UUWW 141630Z 05007MPS 9999 SCT020 17/12 Q1011 NOSIG\nUUDD: METAR UUDD 141600Z 03005MPS 9999 BKN015 15/10 Q1012\nURSS: METAR URSS 141630Z 00000MPS CAVOK 20/15 Q1010", expected: "go", points: 50},
            {route: "ULLI: METAR ULLI 021930Z 00000MPS CAVOK 02/00 Q1032\nEGLL: METAR EGLL 251650Z VRB03KT 9999 FEW030 15/10 Q1018 NOSIG\nKMSN: METAR KMSN 150153Z 14007KT 10SM SCT100 BKN120 M01/M07 A3008", expected: "alternate", points: 30}
        ];

        let stats = JSON.parse(localStorage.getItem('meteoGameStats') || '{"score":0,"level":1,"games":0,"wins":0}');
        function updateStats() {
            document.querySelectorAll('.score').forEach(el => el.textContent = stats.score);
            document.querySelectorAll('.level').forEach(el => el.textContent = stats.level);
            localStorage.setItem('meteoGameStats', JSON.stringify(stats));
            if (stats.score >= stats.level * 150) stats.level++;
        }

        function getRandomItem(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        // Game state variables
        let mode = 'METAR';
        let difficulty = '';
        let currentCode = '';
        let errors = [];
        let selected = new Set();
        let attempts = 3;
        let hintsLeft = 0;
        let currentHint = 1;

        let guessMode = 'metar';
        let currentGuess = null;

        // Initialize game selector UI
        function initGameSelector() {
            document.querySelectorAll('.game-selector button').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.game-selector button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.game-container').forEach(c => c.classList.remove('active'));
                    document.getElementById('game-' + this.dataset.game).classList.add('active');
                });
            });
        }

        // Mode button handlers for choosing code type in games
        document.getElementById('btn-metar')?.addEventListener('click', () => { mode = 'METAR'; updateActiveBtn(); if (difficulty) startGame(difficulty); });
        document.getElementById('btn-taf')?.addEventListener('click', () => { mode = 'TAF'; updateActiveBtn(); if (difficulty) startGame(difficulty); });
        document.getElementById('btn-gamet')?.addEventListener('click', () => { mode = 'GAMET'; updateActiveBtn(); if (difficulty) startGame(difficulty); });
        document.getElementById('btn-sigmet')?.addEventListener('click', () => { mode = 'SIGMET'; updateActiveBtn(); if (difficulty) startGame(difficulty); });
        document.getElementById('btn-warep')?.addEventListener('click', () => { mode = 'WAREP'; updateActiveBtn(); if (difficulty) startGame(difficulty); });
        document.getElementById('btn-kn01')?.addEventListener('click', () => { mode = 'КН-01'; updateActiveBtn(); if (difficulty) startGame(difficulty); });
        document.getElementById('btn-kn04')?.addEventListener('click', () => { mode = 'КН-04'; updateActiveBtn(); if (difficulty) startGame(difficulty); });
        document.getElementById('btn-speci')?.addEventListener('click', () => { mode = 'SPECI'; updateActiveBtn(); if (difficulty) startGame(difficulty); });
        document.getElementById('btn-airmet')?.addEventListener('click', () => { mode = 'AIRMET'; updateActiveBtn(); if (difficulty) startGame(difficulty); });

        function updateActiveBtn() {
            document.querySelectorAll('.mode-buttons .btn').forEach(b => b.classList.remove('active'));
            const btnId = `btn-${mode.toLowerCase().replace('-', '')}`;
            document.getElementById(btnId)?.classList.add('active');
        }

        function startGame(diff) {
            difficulty = diff;
            attempts = 3;
            hintsLeft = (difficulty === 'hard') ? 2 : 1;
            currentHint = 1;
            selected.clear();
            document.getElementById('attempts').textContent = '3';
            document.getElementById('result').innerHTML = '';
            document.getElementById('check-btn').disabled = false;
            document.getElementById('check-btn').onclick = checkAnswer;
            document.getElementById('check-btn').textContent = 'Проверить';

            const list = gameData[mode][diff];
            const item = list[Math.floor(Math.random() * list.length)];
            currentCode = item.code;
            errors = item.errors;
            displayCode();
        }

        function displayCode() {
            const div = document.getElementById('meteo-code');
            div.innerHTML = '';
            const words = currentCode.split(' ');
            words.forEach((word, i) => {
                const span = document.createElement('span');
                span.textContent = word;
                span.onclick = () => toggleSelect(span, i);
                div.appendChild(span);
                div.appendChild(document.createTextNode(' '));
            });
        }

        function toggleSelect(span, index) {
            const maxSelect = (difficulty === 'hard') ? 3 : 4;
            if (selected.has(index)) {
                selected.delete(index);
                span.style.background = '';
                span.style.transform = '';
                span.style.color = '';
            } else if (selected.size < maxSelect) {
                selected.add(index);
                span.style.background = '#f1c40f';
                span.style.transform = 'scale(1.15)';
                span.style.color = 'white';
            }
        }

        function checkAnswer() {
            const correct = errors.length === selected.size && errors.every(e => selected.has(e));

            document.querySelectorAll('#meteo-code span').forEach((span, i) => {
                if (selected.has(i)) {
                    if (errors.includes(i)) {
                        span.style.background = '#27ae60';
                        span.style.color = 'white';
                        span.style.transform = 'scale(1.2)';
                        span.onclick = null;
                    } else {
                        span.style.background = '#e74c3c';
                        span.style.color = 'white';
                        span.style.transform = 'scale(1.2)';
                        span.onclick = null;
                        selected.delete(i);
                    }
                }
            });

            if (correct) {
                const points = difficulty === 'easy' ? 20 : difficulty === 'medium' ? 40 : 80;
                stats.score += points;
                stats.wins++;
                stats.games++;
                if (stats.score >= stats.level * 150) stats.level++;
                updateStats();
                document.getElementById('result').innerHTML = `<span style="color:#27ae60;font-weight:bold">Правильно! +${points} очков!</span>`;
                document.getElementById('check-btn').disabled = true;
                playSound('ding');
                showConfetti();
            } else {
                attempts--;
                document.getElementById('attempts').textContent = attempts;
                if (attempts === 0) {
                    stats.games++;
                    localStorage.setItem('meteoGameStats', JSON.stringify(stats));
                    document.getElementById('result').innerHTML = '<span style="color:#e74c3c;font-weight:bold">Поражение! Правильные группы подсвечены зелёным.</span>';
                    document.querySelectorAll('#meteo-code span').forEach((span, i) => {
                        if (errors.includes(i)) {
                            span.style.background = '#27ae60';
                            span.style.color = 'white';
                            span.style.transform = 'scale(1.2)';
                        }
                    });
                    document.getElementById('check-btn').textContent = 'Заново';
                    document.getElementById('check-btn').onclick = () => startGame(difficulty);
                    playSound('buzz');
                } else {
                    document.getElementById('result').innerHTML = `<span style="color:#e67e22">Неправильно! Осталось попыток: ${attempts}</span>`;
                    playSound('buzz');
                }
            }

            if (attempts === 0 || correct) {
                document.querySelectorAll('#meteo-code span').forEach((span, i) => {
                    if (errors.includes(i)) {
                        const item = gameData[mode][difficulty].find(it => it.code === currentCode);
                        const hint = item ? (difficulty === 'hard' ? (item.hint1 + ' / ' + item.hint2) : item.hint) : 'Ошибка в формате';
                        const tooltip = document.createElement('div');
                        tooltip.className = 'tooltip';
                        tooltip.textContent = hint;
                        span.appendChild(tooltip);
                    }
                });
            }
        }

        function showHintFindError() {
            if (hintsLeft > 0) {
                hintsLeft--;
                let hint;
                if (difficulty === 'hard') {
                    hint = gameData[mode][difficulty].find(i => i.code === currentCode)?.[`hint${currentHint}`] || "Внимательно проверь формат!";
                    currentHint = currentHint === 1 ? 2 : 1;
                } else {
                    hint = gameData[mode][difficulty].find(i => i.code === currentCode)?.hint || "Внимательно проверь формат!";
                }
                document.getElementById('result').innerHTML = `<span style="color:#e67e22">Подсказка: ${hint}</span>`;
            } else {
                alert("Подсказки закончились!");
            }
        }

        // Guess code game
        function startGuessGame() {
            const list = guessGameData.metar;
            currentGuess = list[Math.floor(Math.random() * list.length)];
            attempts = 3;
            document.getElementById('attempts-guess').textContent = '3';
            document.getElementById('phenomenon-desc').textContent = `Явление: ${currentGuess.desc}`;
            document.getElementById('guess-input').value = '';
            document.getElementById('guess-result').innerHTML = '';
            document.getElementById('guess-check').disabled = false;
            document.getElementById('guess-check').onclick = checkGuess;
        }

        function checkGuess() {
            const userGuess = document.getElementById('guess-input').value.trim().toUpperCase();
            if (userGuess === currentGuess.code) {
                const points = 30;
                stats.score += points;
                stats.wins++;
                stats.games++;
                if (stats.score >= stats.level * 150) stats.level++;
                updateStats();
                document.getElementById('guess-result').innerHTML = `<span style="color:#27ae60;font-weight:bold">Правильно! +${points} очков!</span>`;
                document.getElementById('guess-check').disabled = true;
                playSound('ding');
                showConfetti();
            } else {
                attempts--;
                document.getElementById('attempts-guess').textContent = attempts;
                if (attempts === 0) {
                    stats.games++;
                    localStorage.setItem('meteoGameStats', JSON.stringify(stats));
                    document.getElementById('guess-result').innerHTML = '<span style="color:#e74c3c;font-weight:bold">Ты проиграл! Правильный код: ' + currentGuess.code + '</span>';
                    document.getElementById('guess-check').textContent = 'Попробовать ещё раз';
                    document.getElementById('guess-check').onclick = startGuessGame;
                    playSound('buzz');
                } else {
                    document.getElementById('guess-result').innerHTML = `<span style="color:#e67e22">Неправильно! Правильный код: ${currentGuess.code}. Осталось попыток: ${attempts}</span>`;
                    playSound('buzz');
                }
            }
        }

        // Speed decode
        let currentSpeedMetar;
        let timerInterval;
        let timerSpeeds = {slow: 1.5, normal: 1, fast: 0.5};
        let currentTimerSpeed = 'normal';

        function startSpeedDecode() {
            clearInterval(timerInterval);
            const randomMetar = getRandomItem(speedDecodeData);
            document.getElementById('speed-metar').textContent = randomMetar;
            clearSpeedDecode();
            document.getElementById('speed-result').innerHTML = '';
            document.getElementById('new-task-speed-decode').style.display = 'none';

            let timeLeft = 30 * timerSpeeds[currentTimerSpeed];
            document.getElementById('speed-timer').textContent = timeLeft;
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('speed-timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    checkSpeedDecode(true);
                }
            }, 1000);
            currentSpeedMetar = randomMetar;
        }

        function checkSpeedDecode(timeout = false) {
            clearInterval(timerInterval);

            const parsed = parseMetarFields(currentSpeedMetar);
            const inputs = {
                'speed-wind': document.getElementById('speed-wind').value.trim().toUpperCase() === (parsed.wind || '').toUpperCase(),
                'speed-vis': document.getElementById('speed-vis').value.trim().toUpperCase() === (parsed.vis || '').toUpperCase(),
                'speed-temp': document.getElementById('speed-temp').value.trim().toUpperCase() === (parsed.temp || '').toUpperCase(),
                'speed-qnh': document.getElementById('speed-qnh').value.trim().toUpperCase() === (parsed.qnh || '').toUpperCase()
            };
            let correctCount = 0;
            for (const [id, correct] of Object.entries(inputs)) {
                const el = document.getElementById(id);
                el.classList.remove('correct-input', 'incorrect-input');
                el.classList.add(correct ? 'correct-input' : 'incorrect-input');
                if (correct) correctCount++;
            }
            if (!timeout && correctCount > 0) {
                stats.score += correctCount * 10;
                updateStats();
                playSound('ding');
                if (correctCount === 4) showConfetti();
            } else {
                playSound('buzz');
            }
            document.getElementById('speed-result').innerHTML = `Правильно: ${correctCount}/4`;
            if (correctCount === 4) {
                document.getElementById('new-task-speed-decode').style.display = 'block';
            }
        }

        function clearSpeedDecode() {
            document.getElementById('speed-wind').value = '';
            document.getElementById('speed-vis').value = '';
            document.getElementById('speed-temp').value = '';
            document.getElementById('speed-qnh').value = '';
        }

        let currentBuilderCorrect;
        let builderTimerInterval;

        function startCodeBuilder() {
            clearInterval(builderTimerInterval);
            const item = getRandomItem(codeBuilderData);
            document.getElementById('builder-description').textContent = item.description;
            const correctGroups = item.code.split(' ');
            const extraGroups = ['XXXX', '9999', 'NOSIG', 'CAVOK', 'Q9999', 'M01/M01'];
            const allGroups = [...correctGroups, ...extraGroups.slice(0, 3)].sort(() => Math.random() - 0.5);

            const pool = document.getElementById('group-pool');
            pool.innerHTML = '';
            document.getElementById('builder-dropzone').innerHTML = '';
            document.getElementById('builder-result').innerHTML = '';
            document.getElementById('new-task-code-builder').style.display = 'none';

            allGroups.forEach((group, index) => {
                const span = document.createElement('span');
                span.className = 'draggable';
                span.draggable = true;
                span.textContent = group;
                span.id = 'drag-item-' + index;
                span.ondragstart = dragStart;
                pool.appendChild(span);
            });

            currentBuilderCorrect = item.code;
            let timeLeft = 60 * timerSpeeds[currentTimerSpeed];
            document.getElementById('builder-timer').textContent = timeLeft;
            builderTimerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('builder-timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(builderTimerInterval);
                    checkCodeBuilder(true);
                }
            }, 1000);
        }

        function checkCodeBuilder(timeout = false) {
            clearInterval(builderTimerInterval);
            const dropzone = document.getElementById('builder-dropzone');
            const userCode = Array.from(dropzone.children).map(span => span.textContent).join(' ');

            if (userCode === currentBuilderCorrect) {
                const points = timeout ? 0 : 50;
                stats.score += points;
                updateStats();
                document.getElementById('builder-result').innerHTML = `<span style="color:#27ae60; font-weight:bold;">Правильно! +${points} очков</span>`;
                playSound('ding');
                showConfetti();
                document.getElementById('new-task-code-builder').style.display = 'block';
            } else {
                document.getElementById('builder-result').innerHTML = `<span style="color:#e74c3c; font-weight:bold;">Неправильно! (Лишние группы или неправильный порядок)</span><br>Ожидалось: ${currentBuilderCorrect}`;
                playSound('buzz');
            }
        }

        function dragStart(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            ev.effectAllowed = "move";
        }
        function allowDrop(ev) { ev.preventDefault(); }
        function dropToZone(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const el = document.getElementById(data);
            if (el) document.getElementById('builder-dropzone').appendChild(el);
        }
        function dropToPool(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const el = document.getElementById(data);
            if (el) document.getElementById('group-pool').appendChild(el);
        }
        function clearBuilderZone() {
            const dropzone = document.getElementById('builder-dropzone');
            const pool = document.getElementById('group-pool');
            while (dropzone.firstChild) pool.appendChild(dropzone.firstChild);
            document.getElementById('builder-result').innerHTML = '';
        }

        let currentQuizCorrect;
        let quizProgress = 0;
        function startQuizBowl() { quizProgress = 0; nextQuizQuestion(); }
        function nextQuizQuestion() {
            const item = getRandomItem(quizQuestions);
            document.getElementById('quiz-question').textContent = item.question;
            const optionsDiv = document.getElementById('quiz-options');
            optionsDiv.innerHTML = '';
            item.options.forEach((opt, idx) => {
                const label = document.createElement('label');
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'quiz-option';
                radio.value = idx;
                label.appendChild(radio);
                label.appendChild(document.createTextNode(opt));
                optionsDiv.appendChild(label);
            });
            document.getElementById('quiz-result').innerHTML = '';
            document.getElementById('quiz-progress').textContent = `${quizProgress + 1}/10`;
            currentQuizCorrect = item.correct;
        }
        function checkQuiz() {
            const selected = document.querySelector('input[name="quiz-option"]:checked');
            if (selected) {
                if (parseInt(selected.value) === currentQuizCorrect) {
                    stats.score += 10; updateStats(); document.getElementById('quiz-result').innerHTML = '<span style="color:#27ae60">Верно!</span>'; playSound('ding'); showConfetti();
                } else { document.getElementById('quiz-result').innerHTML = '<span style="color:#e74c3c">Ошибка!</span>'; playSound('buzz'); }
                setTimeout(() => {
                    quizProgress++;
                    if (quizProgress < 10) nextQuizQuestion();
                    else document.getElementById('quiz-result').innerHTML = 'Серия завершена!';
                }, 1000);
            }
        }

        let currentTafItem;
        function startTafPredictor() {
            currentTafItem = getRandomItem(tafPredictorData);
            document.getElementById('taf-metar').textContent = currentTafItem.metar;
            document.getElementById('taf-taf').textContent = currentTafItem.taf;
            document.getElementById('taf-question').textContent = currentTafItem.question;
            document.getElementById('taf-answer').value = '';
            document.getElementById('taf-result').textContent = '';
            document.getElementById('new-task-taf-predictor').style.display = 'none';
        }
        function checkTafPredictor() {
            const userAnswer = document.getElementById('taf-answer').value.trim().toLowerCase();
            if (userAnswer === currentTafItem.answer.toLowerCase()) {
                document.getElementById('taf-result').textContent = 'Правильно!';
                stats.score += 25; updateStats(); playSound('ding'); showConfetti();
                document.getElementById('new-task-taf-predictor').style.display = 'block';
            } else {
                document.getElementById('taf-result').textContent = 'Неправильно. Правильный ответ: ' + currentTafItem.answer;
                playSound('buzz');
            }
        }

        // Flight planner
        let currentPlannerItem;
        function startFlightPlanner() {
            currentPlannerItem = getRandomItem(flightPlannerData);
            document.getElementById('planner-route').textContent = currentPlannerItem.route;
            document.getElementById('planner-decision').value = '';
            document.getElementById('planner-result').textContent = '';
        }
        function checkFlightPlanner() {
            const decision = document.getElementById('planner-decision').value;
            if (decision === currentPlannerItem.expected) {
                stats.score += currentPlannerItem.points; updateStats(); document.getElementById('planner-result').textContent = 'Правильно!'; playSound('ding'); showConfetti();
            } else { document.getElementById('planner-result').textContent = 'Неправильно!'; playSound('buzz'); }
        }

        function showHintGuessCode() { alert('Подсказка: Вспомните стандартные коды погоды в METAR.'); }
        function showHintSpeedDecode() { alert('Подсказка: Разбейте METAR на группы: ветер, видимость, температура, давление.'); }
        function showHintCodeBuilder() { alert('Подсказка: Порядок групп в METAR: аэропорт, время, ветер, видимость, облачность, температура, давление, прогноз.'); }
        function showHintQuizBowl() { alert('Подсказка: Ответьте на основе знаний о метеокодах.'); }
        function showHintTafPredictor() { alert('Подсказка: Проанализируйте изменения в TAF по сравнению с METAR.'); }
        function showHintFlightPlanner() { alert('Подсказка: Оцените погоду по критериям go/no-go.'); }

        function playSound(type) {
            const sound = document.getElementById(type + '-sound');
            if (sound) sound.play();
        }

        function showConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const particles = [];
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    r: Math.random() * 4 + 1,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    vx: Math.random() * 2 - 1,
                    vy: Math.random() * 2 - 1
                });
            }
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                    p.x += p.vx;
                    p.y += p.vy;
                    p.r *= 0.98;
                });
                if (particles[0].r > 0.1) requestAnimationFrame(draw);
                else canvas.style.display = 'none';
            }
            canvas.style.display = 'block';
            draw();
        }
        let currentSettingsGame = '';
        function openSettings(game) { currentSettingsGame = game; document.getElementById('settings-panel').style.display = 'block'; }
        function applySettings() {
            currentTimerSpeed = document.getElementById('timer-speed').value;
            closeSettings();
            if (currentSettingsGame === 'speed-decode') startSpeedDecode();
            if (currentSettingsGame === 'code-builder') startCodeBuilder();
        }
        function closeSettings() { document.getElementById('settings-panel').style.display = 'none'; }
        function initTopMenu() {
            document.querySelectorAll('.top-menu button').forEach(btn => {
                btn.addEventListener('click', function () {
                    if (this.disabled) return;
                    document.querySelectorAll('.top-menu button').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    const pageId = 'page-' + this.dataset.page;
                    if (document.getElementById(pageId)) {
                        document.getElementById(pageId).classList.add('active');
                    }
                });
            });
        }
        try { updateActiveBtn(); } catch(e){}
    </script>
</body>
</html>